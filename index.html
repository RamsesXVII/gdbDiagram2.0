<head>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

</head>

<body>
  
  <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
  <script>
function convertDateFotmate(p1) {
    year=p1.getFullYear().toString()
    month=(p1.getMonth()+1).toString()     
    day=p1.getDate().toString()
    hour=p1.getHours().toString()
    minutes=p1.getMinutes().toString()
    seconds=p1.getSeconds().toString()
    return year+"-"+month+"-"+day+"T"+hour+":"+minutes+":"+  seconds    // The function returns the product of p1 and p2
}


d3.json("https://stat.ripe.net/data/bgplay/data.json?resource=193.204.167.185", function(error,json){
    start=json.data.query_starttime
    end=json.data.query_endtime

    asPathToId=new Object()
    asPathToId["W"]=0

    idSequence=[]
    timestampSequence=[]
    timestampSequenceCompressed=[]

    counterTimestampCompressed=new Date(start)

    counter=100




    cp="04-192.65.185.195"
    


    inistialState=json.data.initial_state

    for (var i = 0; i < inistialState.length; i++) {
     // console.log(inistialState[i].source_id)
      if(inistialState[i].source_id==cp){
        asPathToId[inistialState[i].path]=counter
        idSequence.push(counter)

        timestampSequence.push(start)
        timestampSequenceCompressed.push(counterTimestampCompressed.toString())
        
        counter=counter+100
        break
      }
      idSequence.push(0)
      timestampSequence.push(start)
      timestampSequenceCompressed.push(counterTimestampCompressed.toString())

    }

    events=json.data.events

    for (var i = 0; i < events.length; i++) {
      record=events[i]
      if (record.attrs.source_id==cp){
        if (record.type=="A"){
          path=record.attrs.path
          timestamp=record.timestamp
          prev=idSequence[idSequence.length-1]

          idSequence.push(prev)
          timestampSequence.push(timestamp)
          counterTimestampCompressed.setMinutes(counterTimestampCompressed.getMinutes() + 1);
          timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))

          id=asPathToId[path]

          if(id==undefined){
            asPathToId[path]=counter
            idSequence.push(counter)
            timestampSequence.push(timestamp)
            timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))
            counter=counter+100
          }
          else{
            idSequence.push(id)
            timestampSequence.push(timestamp)
          timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))

          }
         }
         else{
            timestamp=record.timestamp
            prev=idSequence[idSequence.length-1]

            counterTimestampCompressed.setMinutes(counterTimestampCompressed.getMinutes() + 1);
          timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))

            idSequence.push(prev)
            
            timestampSequence.push(timestamp)
          timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))
            
            idSequence.push(0)
            
            timestampSequence.push(timestamp)
          timestampSequenceCompressed.push(convertDateFotmate(counterTimestampCompressed))

         }
      }
    }




    var trace1 = {
      type: "scatter",
      mode: "lines",
      name: 'AAPL High',
      x: timestampSequence,
      y: idSequence,
      line: {color: '#17BECF'}
    }
    var trace2 = {
      type: "scatter",
      mode: "lines",
      name: 'AAPL Low',
      x: timestampSequenceCompressed,
      y: idSequence,
      line: {color: '#7F7F7F'}
    }


    var data = [trace1,trace2];
        
    var layout = {
      title: 'GdbDiagram', 
      xaxis: {
        autorange: true, 
        range: [start, end], 
        rangeselector: {buttons: [
            {
              count: 1, 
              label: '1m', 
              step: 'month', 
              stepmode: 'backward'
            }, 
            {
              count: 6, 
              label: '6m', 
              step: 'month', 
              stepmode: 'backward'
            }, 
            {step: 'all'}
          ]}, 
        rangeslider: {range: [start, end]}, 
        type: 'date'
      }, 
      yaxis: {
        autorange: true, 
        range: [0, counter], 
        type: 'linear'
      }
    };

    Plotly.newPlot('myDiv', data, layout);
    })
  </script>
</body>
